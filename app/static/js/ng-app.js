"use strict";!function(){angular.module("apox",[])}(),function(){var t=function(t){var n=this;n.location={},n.mapData={},n.showDetailPanel=!0,n.dataLoaded=!1,n.closeDetailPanel=function(){n.showDetailPanel=!1},n.loadMapData=function(){t.loadMap().then(function(t){n.mapData=t.data,n.dataLoaded=!0})},n.updateLocationDetails=function(){var e=n.location;e.id>0&&t.updateLocation(e.id,{name:e.name,longitude:e.longitude,latitude:e.latitude,description:e.description,population:e.population,tech:e.tech,type:e.type,factionid:e.factionid}).catch(function(){window.alert("PATCH ERROR")})},n.loadMapData()};angular.module("apox").controller("AdminMapController",["MapService",t])}(),function(){var t=function(t){return{restrict:"E",template:'<canvas class="map-canvas" resize="true"></canvas>',link:function(n,e){paper.setup(e.context.firstChild);var a=new paper.Layer;a.texasMap=new paper.Raster("/img/texasmap.jpg");var o=new paper.Layer;n.$watch("admin.dataLoaded",function(){if(n.admin.dataLoaded){var a=n.admin.mapData;t.render({isAdmin:!0,data:a,scope:n,mapLayer:o}),t.setupMouseWheel(e,{pan:!0,zoom:!0,zoomAlt:!0})}}),paper.view.center=new paper.Point(1100,500),e.bind("mousewheel",t.onMouseWheel)}}};angular.module("apox").directive("apoxAdminMap",["MapRenderer",t])}(),function(){var t=function(t,n,e,a){var o=this;o.working=!1,o.traveling=!1,o.factionTags=["","republic","confederation","alliance","petrex","light"],n.getDriver().then(function(t){o.driver=t}),o.getCurrentLocation=function(){e.getCurrentLocation().then(function(t){o.currentLocation=t})},o.getCurrentDestination=function(){a.getCurrentTrip().then(function(t){t.trip[0]&&(o.destinationName=t.trip[0].name,o.destinationId=t.trip[0].id)})},o.setDestination=function(t){o.working=!0,a.setNextDestination(t).then(function(t){t.ok&&(o.destinationName=t.name,o.destinationId=t.id,o.working=!1)})},o.goDestination=function(){o.working=!0,a.beginTrip().then(function(t){"ok"===t&&(o.getCurrentLocation(),o.destinationName=void 0,o.destinationId=void 0,o.working=!1)})},o.clearDestination=function(){o.working=!0,a.clearTrip().then(function(t){"ok"===t&&(o.destinationName=void 0,o.destinationId=void 0,o.working=!1)})},o.getCurrentLocation(),o.getCurrentDestination(),console.log(o)};angular.module("apox").controller("GamePageController",["GameService","DriverService","LocationService","TripService",t])}(),function(){var t=function(t){var n=this;n.mapData={},n.dataLoaded=!1,n.loadMapData=function(){n.dataLoaded=!1,t.loadMap().then(function(t){n.mapData=t.data,n.dataLoaded=!0})},n.loadMapData()};angular.module("apox").controller("GameMapController",["MapService",t])}(),function(){var t=function(t){return{restrict:"E",template:'<canvas class="map-canvas" resize="true"></canvas>',link:function(n,e){function a(){if(n.$parent.game.currentLocation&&n.map.mapData.locations){var t=n.map.mapData.locations[n.$parent.game.currentLocation.id];paper.view.center=new paper.Point(t.point.x,t.point.y)}}paper.setup(e.context.firstChild);var o=new paper.Layer;o.texasMap=new paper.Raster("/img/texasmap2.jpg");var i=new paper.Layer;n.$watch("map.dataLoaded",function(){if(n.map.dataLoaded){var o=n.map.mapData;t.render({isAdmin:!1,data:o,mapLayer:i}),a()}t.setupMouseWheel(e,{zoom:!0})}),n.$watch("$parent.game.currentLocation",function(){a()})}}};angular.module("apox").directive("apoxMap",["MapRenderer",t])}(),function(){var t="/driver",n=function(n,e){return{getDriver:function(){return e(function(e,a){n.get(t).then(function(t){e(t.data)},function(t){a(t)})})}}};angular.module("apox").factory("DriverService",["$http","$q",n])}(),function(){var t=function(){return{booyah:function(){console.log("BOOYAH")}}};angular.module("apox").factory("GameService",[t])}(),function(){var t="/location",n=function(n,e){return{getCurrentLocation:function(){return e(function(e,a){n.get(t).then(function(t){e(t.data)},function(t){a(t)})})}}};angular.module("apox").factory("LocationService",["$http","$q",n])}(),function(){var t=function(){function t(t){return new paper.Point(t.longitude*d+f,t.latitude*s+m)}function n(t){return{longitude:(t.x-f)/d,latitude:(t.y-m)/s}}function e(t){var n=t.target.parent;t.target.remove(),n.addChild(t.target),t.target.children.dot.fillColor.alpha=.5;for(var e=0;e<t.target.location.paths.length;e++)t.target.location.paths[e].strokeColor=new paper.Color(0,0,0,.5);t.target.scope.$apply(function(){t.target.scope.admin.showDetailPanel=!0,t.target.scope.admin.location=t.target.location})}function a(t){t.target.children.dot.fillColor.alpha=1;for(var n=0;n<t.target.location.paths.length;n++)t.target.location.paths[n].strokeColor="black"}function o(t){var e=t.target;e.position=e.position.add([t.delta.x,t.delta.y]);for(var a=0;a<e.location.paths.length;a++)e.location.ends[a].x=e.children.dot.position.x,e.location.ends[a].y=e.children.dot.position.y;var o=n(e.position);e.location.longitude=o.longitude,e.location.latitude=o.latitude,e.scope.$apply(function(){e.scope.admin.location.longitude=o.longitude,e.scope.admin.location.latitude=o.latitude}),t.stopPropagation()}function i(t){t.target.children.locname.visible=!0}function r(t){t.target.children.locname.visible=!1}function c(t,n,e,a){var o=1.05,i=t;n>0&&(i*=o),n<0&&(i/=o);var r=t/i,c=a.subtract(e),p=a.subtract(c.multiply(r)).subtract(e);return{newZoom:i,a:p}}function p(t,n,e,a){var o=new paper.Point(n,e).multiply(a);return t.subtract(o)}function u(t,n){var e=1,a=.2;n.zoom&&t.bind("mousewheel",function(t){if(!n.zoomAlt||t.altKey){var o=new paper.Point(t.offsetX,t.offsetY),i=c(paper.view.zoom,t.originalEvent.wheelDeltaY,paper.view.center,o);i.newZoom<e&&i.newZoom>a&&(paper.view.zoom=i.newZoom),t.preventDefault()}}),n.pan&&t.bind("mousewheel",function(t){paper.view.center=p(paper.view.center,t.originalEvent.wheelDeltaX,t.originalEvent.wheelDeltaY,1),t.preventDefault()})}function l(n){var c=n.isAdmin,p=n.data,u=n.scope,l=n.mapLayer;p.locations&&p.connections&&!function(){Object.keys(p.locations).forEach(function(n){p.locations[n].point=t(p.locations[n]),p.locations[n].paths=[],p.locations[n].ends=[]}),l.removeChildren();for(var n=0;n<p.connections.length;n++){var d=p.connections[n],s=p.locations[d.start],f=p.locations[d.end];if(s&&f){var m=new paper.Path.Line(s.point,f.point);m.strokeColor="black",m.strokeWidth=g,l.addChild(m),s.ends.push(m.segments[0].point),f.ends.push(m.segments[1].point),s.paths.push(m),f.paths.push(m)}}var w=[0,-20],C=Object.keys(p.locations).sort(function(t,n){return p.locations[t].latitude<p.locations[n].latitude});C.forEach(function(t){var n=p.locations[t],d=new paper.Path.Circle({center:n.point,radius:v*Math.ceil(Math.log10(n.population)),fillColor:h[n.factionid],strokeColor:"black",name:"dot"}),s=new paper.PointText({point:n.point.add(w),justification:"center",fillColor:"white",strokeColor:"black",strokeWidth:.5,content:n.name,name:"locname",visible:!c,fontSize:30}),f=new paper.Group([d,s]);f.location=n,f.scope=u,c&&(f.onMouseEnter=i,f.onMouseLeave=r,f.onMouseDrag=o,f.onMouseDown=e,f.onMouseUp=a),l.addChild(f)})}()}var d=435.3,s=-506.5,f=43647,m=15855,v=3,g=3,h=[new paper.Color(0,0,0),new paper.Color("#6666ff"),new paper.Color("#ff6666"),new paper.Color("#669966"),new paper.Color("#ac00e6"),new paper.Color("#ffff66")];return{render:l,setupMouseWheel:u}};angular.module("apox").factory("MapRenderer",t)}(),function(){var t=function(t){return{loadMap:function(){return t.get("/map")},updateLocation:function(n,e){return t.patch("/admin/map/location/"+n,e)}}};angular.module("apox").factory("MapService",["$http",t])}(),function(){var t="/trip",n=function(n,e){return{getCurrentTrip:function(){return e(function(e,a){n.get(t).then(function(t){e(t.data)},function(t){a(t)})})},setNextDestination:function(a){return e(function(e,o){n.put(t,{destination:a}).then(function(t){e(t.data)},function(t){o(t)})})},clearTrip:function(){return e(function(e,a){n.delete(t).then(function(t){e(t.data)},function(t){a(t)})})},beginTrip:function(){return e(function(e,a){n.post(t).then(function(t){e(t.data)},function(t){a(t)})})}}};angular.module("apox").factory("TripService",["$http","$q",n])}();