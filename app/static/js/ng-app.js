"use strict";!function(){angular.module("apox",[])}(),function(){var n=function(n){var t=this;t.location={},t.mapData={},t.showDetailPanel=!0,t.dataLoaded=!1,t.closeDetailPanel=function(){t.showDetailPanel=!1},t.loadMapData=function(){n.getMap().then(function(n){t.mapData.locations=n.data.locations,t.mapData.connections=n.data.connections,t.dataLoaded=!0})},t.updateLocationDetails=function(){var e=t.location;e.id>0&&n.updateLocation(e.id,{name:e.name,longitude:e.longitude,latitude:e.latitude,description:e.description,population:e.population,tech:e.tech,type:e.type,factionid:e.factionid}).catch(function(){window.alert("PATCH ERROR")})},t.loadMapData()};angular.module("apox").controller("AdminMapController",["MapService",n])}(),function(){var n=function(n){return{restrict:"E",template:'<canvas class="map-canvas" resize="true"></canvas>',link:function(t,e){paper.setup(e.context.firstChild);var o=new paper.Layer;o.texasMap=new paper.Raster("/img/texasmap.jpg");var a=new paper.Layer,i=new paper.Layer;t.$watch("admin.dataLoaded",function(){var e=t.admin.mapData;n.render(e,t,a,i)}),paper.view.center=new paper.Point(1100,500),e.bind("mousewheel",n.onMouseWheel)}}};angular.module("apox").directive("apoxAdminMap",["RenderMap",n])}(),function(){var n=function(n,t,e){var o=this;o.working=!1,o.traveling=!1,o.factionTags=["","republic","confederation","alliance","petrex","light"],n.getDriver().then(function(n){o.driver=n}),o.getCurrentConnections=function(){t.getCurrentLocation().then(function(n){for(var t=[],e=0;e<n.connections.length;e++){var a=n.connections[e];a.name!==n.name&&(a.id=a.loc1===n.id?a.loc2:a.loc1,delete a.loc1,delete a.loc2,t.push(a))}n.connections=t,o.currentLocation=n})},o.getCurrentDestination=function(){e.getCurrentTrip().then(function(n){n.trip[0]&&(o.destinationName=n.trip[0].name,o.destinationId=n.trip[0].id)})},o.setDestination=function(n){o.working=!0,e.setNextDestination(n).then(function(n){n.ok&&(o.destinationName=n.name,o.destinationId=n.id,o.working=!1)})},o.goDestination=function(){o.working=!0,e.beginTrip().then(function(n){"ok"===n&&(o.working=!1,o.getCurrentConnections(),o.destinationName=void 0,o.destinationId=void 0)})},o.clearDestination=function(){o.working=!0,e.clearTrip().then(function(n){"ok"===n&&(o.destinationName=void 0,o.destinationId=void 0,o.working=!1)})},o.getCurrentConnections(),o.getCurrentDestination()};angular.module("apox").controller("GamePageController",["DriverService","LocationService","TripService",n])}(),function(){var n=function(n){var t=this;t.location={},t.mapData={},t.dataLoaded=!1,t.loadMapData=function(){n.getMap().then(function(n){t.mapData.locations=n.data.locations,t.mapData.connections=n.data.connections,t.dataLoaded=!0})},t.loadMapData()};angular.module("apox").controller("GameMapController",["MapService",n])}(),function(){var n=function(n){return{restrict:"E",template:'<canvas class="map-canvas" resize="true"></canvas>',link:function(t,e){paper.setup(e.context.firstChild);var o=new paper.Layer;o.texasMap=new paper.Raster("/img/texasmap.jpg");var a=new paper.Layer,i=new paper.Layer;t.$watch("map.dataLoaded",function(){var e=t.map.mapData;n.render(e,t,a,i)}),paper.view.center=new paper.Point(1100,500),e.bind("mousewheel",n.onMouseWheel)}}};angular.module("apox").directive("apoxMap",["RenderMap",n])}(),function(){var n="/driver",t=function(t,e){return{getDriver:function(){return e(function(e,o){t.get(n).then(function(n){e(n.data)},function(n){o(n)})})}}};angular.module("apox").factory("DriverService",["$http","$q",t])}(),function(){var n="/location",t=function(t,e){return{getCurrentLocation:function(){return e(function(e,o){t.get(n).then(function(n){e(n.data)},function(n){o(n)})})}}};angular.module("apox").factory("LocationService",["$http","$q",t])}(),function(){var n=function(){function n(n){return new paper.Point(n.longitude*d+f,n.latitude*s+g)}function t(n){return{longitude:(n.x-f)/d,latitude:(n.y-g)/s}}function e(n){var t=n.target.parent;n.target.remove(),t.addChild(n.target),n.target.children.dot.fillColor.alpha=.5;for(var e=0;e<n.target.location.paths.length;e++)n.target.location.paths[e].strokeColor=new paper.Color(0,0,0,.5);n.target.scope.$apply(function(){n.target.scope.admin.showDetailPanel=!0,n.target.scope.admin.location=n.target.location})}function o(n){n.target.children.dot.fillColor.alpha=1;for(var t=0;t<n.target.location.paths.length;t++)n.target.location.paths[t].strokeColor="black"}function a(n){var e=n.target;e.position=e.position.add([n.delta.x,n.delta.y]);for(var o=0;o<e.location.paths.length;o++)e.location.ends[o].x=e.children.dot.position.x,e.location.ends[o].y=e.children.dot.position.y;var a=t(e.position);e.location.longitude=a.longitude,e.location.latitude=a.latitude,e.scope.$apply(function(){e.scope.admin.location.longitude=a.longitude,e.scope.admin.location.latitude=a.latitude}),n.stopPropagation()}function i(n){n.target.children.locname.visible=!0}function r(n){n.target.children.locname.visible=!1}function c(n,t,e,o){var a=1.05,i=n;t>0&&(i*=a),t<0&&(i/=a);var r=n/i,c=o.subtract(e),l=o.subtract(c.multiply(r)).subtract(e);return{newZoom:i,a:l}}function l(n,t,e,o){var a=new paper.Point(t,e).multiply(o);return n.subtract(a)}function p(n){var t=n.originalEvent.wheelDeltaX,e=n.originalEvent.wheelDeltaY;if(n.altKey){var o=new paper.Point(n.offsetX,n.offsetY),a=c(paper.view.zoom,e,paper.view.center,o);paper.view.zoom=a.newZoom,n.preventDefault()}else paper.view.center=l(paper.view.center,t,e,1),n.preventDefault()}function u(t,c,l,p){t.locations&&t.connections&&!function(){Object.keys(t.locations).forEach(function(e){t.locations[e].point=n(t.locations[e]),t.locations[e].paths=[],t.locations[e].ends=[]});for(var u=0;u<t.connections.length;u++){var d=t.connections[u],s=t.locations[d.loc1],f=t.locations[d.loc2],g=new paper.Path.Line(s.point,f.point);g.strokeColor="black",g.strokeWidth=h,s.ends.push(g.segments[0].point),f.ends.push(g.segments[1].point),s.paths.push(g),f.paths.push(g)}var w=[0,-20],C=Object.keys(t.locations).sort(function(n,e){return t.locations[n].latitude>t.locations[e].latitude});C.forEach(function(n){var u=t.locations[n],d=new paper.Path.Circle({center:u.point,radius:v*Math.ceil(Math.log10(u.population))*40,name:"faction"});d.fillColor={gradient:{stops:[[m[u.factionid],.6],[new paper.Color(255,255,255,0),1]],radial:!0},origin:d.position,destination:d.bounds.rightCenter},l.addChild(d);var s=new paper.Path.Circle({center:u.point,radius:v*Math.ceil(Math.log10(u.population)),fillColor:"black",name:"dot"}),f=new paper.PointText({point:u.point.add(w),justification:"center",fillColor:"black",strokeColor:"white",content:u.name,name:"locname",visible:!1,fontSize:30}),g=new paper.Group([s,f]);g.location=u,g.scope=c,g.onMouseEnter=i,g.onMouseLeave=r,g.onMouseDrag=a,g.onMouseDown=e,g.onMouseUp=o,p.addChild(g)})}()}var d=435.3,s=-506.5,f=43647,g=15855,v=3,h=3,m=[new paper.Color(0,0,0,.95),new paper.Color(0,0,255,.2),new paper.Color(255,0,0,.2),new paper.Color(0,255,0,.2),new paper.Color(75,0,130,.2),new paper.Color(255,255,0,.2)];return{onMouseWheel:p,render:u}};angular.module("apox").factory("RenderMap",n)}(),function(){var n=function(n){return{getMap:function(){return n.get("/map")},updateLocation:function(t,e){return n.patch("/admin/map/location/"+t,e)}}};angular.module("apox").factory("MapService",["$http",n])}(),function(){var n="/trip",t=function(t,e){return{getCurrentTrip:function(){return e(function(e,o){t.get(n).then(function(n){e(n.data)},function(n){o(n)})})},setNextDestination:function(o){return e(function(e,a){t.put(n,{destination:o}).then(function(n){e(n.data)},function(n){a(n)})})},clearTrip:function(){return e(function(e,o){t.delete(n).then(function(n){e(n.data)},function(n){o(n)})})},beginTrip:function(){return e(function(e,o){t.post(n).then(function(n){e(n.data)},function(n){o(n)})})}}};angular.module("apox").factory("TripService",["$http","$q",t])}();