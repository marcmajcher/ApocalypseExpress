"use strict";!function(){angular.module("apox",[])}(),function(){var n=function(n){var t=this;t.location={},t.mapData={},t.showDetailPanel=!0,t.dataLoaded=!1,t.closeDetailPanel=function(){t.showDetailPanel=!1},t.loadMapData=function(){n.getMap().then(function(n){t.mapData.locations=n.data.locations,t.mapData.connections=n.data.connections,t.dataLoaded=!0})},t.updateLocationDetails=function(){var a=t.location;a.id>0&&n.updateLocation(a.id,{name:a.name,longitude:a.longitude,latitude:a.latitude,description:a.description,population:a.population,tech:a.tech,type:a.type,factionid:a.factionid}).catch(function(){window.alert("PATCH ERROR")})},t.loadMapData()};angular.module("apox").controller("AdminMapController",["MapService",n])}(),function(){var n=function(n){return{restrict:"E",template:'<canvas class="map-canvas" resize="true"></canvas>',link:function(t,a){paper.setup(a.context.firstChild);var e=new paper.Layer;e.texasMap=new paper.Raster("/img/texasmap.jpg");var o=new paper.Layer,i=new paper.Layer;t.$watch("admin.dataLoaded",function(){if(t.admin.dataLoaded){var a=t.admin.mapData;n.render({isAdmin:!0,data:a,scope:t,factionLayer:o,mapLayer:i})}}),paper.view.center=new paper.Point(1100,500),a.bind("mousewheel",n.onMouseWheel)}}};angular.module("apox").directive("apoxAdminMap",["MapRenderer",n])}(),function(){var n=function(n,t,a){var e=this;e.working=!1,e.traveling=!1,e.factionTags=["","republic","confederation","alliance","petrex","light"],n.getDriver().then(function(n){e.driver=n}),e.getCurrentConnections=function(){t.getCurrentLocation().then(function(n){for(var t=[],a=0;a<n.connections.length;a++){var o=n.connections[a];o.name!==n.name&&(o.id=o.loc1===n.id?o.loc2:o.loc1,delete o.loc1,delete o.loc2,t.push(o))}n.connections=t,e.currentLocation=n})},e.getCurrentDestination=function(){a.getCurrentTrip().then(function(n){n.trip[0]&&(e.destinationName=n.trip[0].name,e.destinationId=n.trip[0].id)})},e.setDestination=function(n){e.working=!0,a.setNextDestination(n).then(function(n){n.ok&&(e.destinationName=n.name,e.destinationId=n.id,e.working=!1)})},e.goDestination=function(){e.working=!0,a.beginTrip().then(function(n){"ok"===n&&(e.working=!1,e.getCurrentConnections(),e.destinationName=void 0,e.destinationId=void 0)})},e.clearDestination=function(){e.working=!0,a.clearTrip().then(function(n){"ok"===n&&(e.destinationName=void 0,e.destinationId=void 0,e.working=!1)})},e.getCurrentConnections(),e.getCurrentDestination()};angular.module("apox").controller("GamePageController",["DriverService","LocationService","TripService",n])}(),function(){var n=function(n){var t=this;t.location={},t.mapData={},t.dataLoaded=!1,t.loadMapData=function(){n.getMap().then(function(n){t.mapData.locations=n.data.locations,t.mapData.connections=n.data.connections,t.dataLoaded=!0})},t.loadMapData()};angular.module("apox").controller("GameMapController",["MapService",n])}(),function(){var n=function(n){return{restrict:"E",template:'<canvas class="map-canvas" resize="true"></canvas>',link:function(t,a){function e(){if(t.$parent.game.currentLocation&&t.map.mapData.locations){var n=t.map.mapData.locations[t.$parent.game.currentLocation.id];paper.view.center=new paper.Point(n.point.x,n.point.y)}}paper.setup(a.context.firstChild);var o=new paper.Layer;o.texasMap=new paper.Raster("/img/texasmap2.jpg"),o.opacity=.5;var i=new paper.Layer,r=new paper.Layer;a.bind("mousewheel",n.onMouseWheel),t.$watch("map.dataLoaded",function(){if(t.map.dataLoaded){var a=t.map.mapData;n.render({isAdmin:!1,data:a,scope:t,factionLayer:i,mapLayer:r}),e()}}),t.$watch("$parent.game.currentLocation",function(){e()})}}};angular.module("apox").directive("apoxMap",["MapRenderer",n])}(),function(){var n="/driver",t=function(t,a){return{getDriver:function(){return a(function(a,e){t.get(n).then(function(n){a(n.data)},function(n){e(n)})})}}};angular.module("apox").factory("DriverService",["$http","$q",t])}(),function(){var n="/location",t=function(t,a){return{getCurrentLocation:function(){return a(function(a,e){t.get(n).then(function(n){a(n.data)},function(n){e(n)})})}}};angular.module("apox").factory("LocationService",["$http","$q",t])}(),function(){var n=function(){function n(n){return new paper.Point(n.longitude*d+f,n.latitude*s+g)}function t(n){return{longitude:(n.x-f)/d,latitude:(n.y-g)/s}}function a(n){var t=n.target.parent;n.target.remove(),t.addChild(n.target),n.target.children.dot.fillColor.alpha=.5;for(var a=0;a<n.target.location.paths.length;a++)n.target.location.paths[a].strokeColor=new paper.Color(0,0,0,.5);n.target.scope.$apply(function(){n.target.scope.admin.showDetailPanel=!0,n.target.scope.admin.location=n.target.location})}function e(n){n.target.children.dot.fillColor.alpha=1;for(var t=0;t<n.target.location.paths.length;t++)n.target.location.paths[t].strokeColor="black"}function o(n){var a=n.target;a.position=a.position.add([n.delta.x,n.delta.y]);for(var e=0;e<a.location.paths.length;e++)a.location.ends[e].x=a.children.dot.position.x,a.location.ends[e].y=a.children.dot.position.y;var o=t(a.position);a.location.longitude=o.longitude,a.location.latitude=o.latitude,a.scope.$apply(function(){a.scope.admin.location.longitude=o.longitude,a.scope.admin.location.latitude=o.latitude}),n.stopPropagation()}function i(n){n.target.children.locname.visible=!0}function r(n){n.target.children.locname.visible=!1}function c(n,t,a,e){var o=1.05,i=n;t>0&&(i*=o),t<0&&(i/=o);var r=n/i,c=e.subtract(a),p=e.subtract(c.multiply(r)).subtract(a);return{newZoom:i,a:p}}function p(n,t,a,e){var o=new paper.Point(t,a).multiply(e);return n.subtract(o)}function l(n){var t=n.originalEvent.wheelDeltaX,a=n.originalEvent.wheelDeltaY;if(n.altKey){var e=new paper.Point(n.offsetX,n.offsetY),o=c(paper.view.zoom,a,paper.view.center,e);paper.view.zoom=o.newZoom,n.preventDefault()}else paper.view.center=p(paper.view.center,t,a,1),n.preventDefault()}function u(t){var c=t.isAdmin,p=t.data,l=t.scope,u=t.mapLayer,d=t.factionLayer;p.locations&&p.connections&&!function(){Object.keys(p.locations).forEach(function(t){p.locations[t].point=n(p.locations[t]),p.locations[t].paths=[],p.locations[t].ends=[]});for(var t=0;t<p.connections.length;t++){var s=p.connections[t],f=p.locations[s.loc1],g=p.locations[s.loc2];if(f&&g){var w=new paper.Path.Line(f.point,g.point);w.strokeColor=c?"black":"dimgrey",w.strokeWidth=v,f.ends.push(w.segments[0].point),g.ends.push(w.segments[1].point),f.paths.push(w),g.paths.push(w)}}var C=[0,-20],D=Object.keys(p.locations).sort(function(n,t){return p.locations[n].latitude>p.locations[t].latitude});D.forEach(function(n){var t=p.locations[n],s=new paper.Path.Circle({center:t.point,radius:m*Math.ceil(Math.log10(t.population))*40,name:"faction"});s.fillColor={gradient:{stops:[[h[t.factionid],.6],[new paper.Color(255,255,255,0),1]],radial:!0},origin:s.position,destination:s.bounds.rightCenter},d.addChild(s);var f=new paper.Path.Circle({center:t.point,radius:m*Math.ceil(Math.log10(t.population)),fillColor:c?"black":"dimgrey",name:"dot"}),g=new paper.PointText({point:t.point.add(C),justification:"center",fillColor:"black",strokeColor:c?"white":"none",content:t.name,name:"locname",visible:!c,fontSize:30}),v=new paper.Group([f,g]);v.location=t,v.scope=l,c&&(v.onMouseEnter=i,v.onMouseLeave=r,v.onMouseDrag=o,v.onMouseDown=a,v.onMouseUp=e),u.addChild(v)}),d.visible=c}()}var d=435.3,s=-506.5,f=43647,g=15855,m=3,v=3,h=[new paper.Color(0,0,0,.95),new paper.Color(0,0,255,.2),new paper.Color(255,0,0,.2),new paper.Color(0,255,0,.2),new paper.Color(75,0,130,.2),new paper.Color(255,255,0,.2)];return{onMouseWheel:l,render:u}};angular.module("apox").factory("MapRenderer",n)}(),function(){var n=function(n){return{getMap:function(){return n.get("/map")},updateLocation:function(t,a){return n.patch("/admin/map/location/"+t,a)}}};angular.module("apox").factory("MapService",["$http",n])}(),function(){var n="/trip",t=function(t,a){return{getCurrentTrip:function(){return a(function(a,e){t.get(n).then(function(n){a(n.data)},function(n){e(n)})})},setNextDestination:function(e){return a(function(a,o){t.put(n,{destination:e}).then(function(n){a(n.data)},function(n){o(n)})})},clearTrip:function(){return a(function(a,e){t.delete(n).then(function(n){a(n.data)},function(n){e(n)})})},beginTrip:function(){return a(function(a,e){t.post(n).then(function(n){a(n.data)},function(n){e(n)})})}}};angular.module("apox").factory("TripService",["$http","$q",t])}();